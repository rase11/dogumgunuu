<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sana √ñzel Bir Oyun v7.0 (Zor + Giri≈ü)</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <style>
        body { 
            margin: 0; 
            background-color: #000; 
            overflow: hidden; 
            font-family: 'Arial Black', sans-serif;
            touch-action: none;
        }
        #game-container { 
            width: 100vw; 
            height: 100vh; 
        }

        /* UYARI EKRANI STƒ∞Lƒ∞ */
        #orientation-warning {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #222;
            color: #fff;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            text-align: center;
        }
        #orientation-warning h1 { font-size: 50px; margin-bottom: 20px; }
        
        @media screen and (orientation: portrait) {
            #orientation-warning { display: flex; }
            #game-container { display: none; }
        }
    </style>
</head>
<body>

<div id="orientation-warning">
    <h1>üì±‚ÜîÔ∏è</h1>
    <h2>L√ºtfen Telefonu Yan √áevir</h2>
    <p>Oyun keyfi i√ßin ekranƒ± d√∂nd√ºr.</p>
</div>

<div id="game-container"></div>

<script>
    const config = {
        type: Phaser.AUTO,
        parent: 'game-container',
        scale: {
            mode: Phaser.Scale.RESIZE,
            width: '100%',
            height: '100%',
            autoCenter: Phaser.Scale.CENTER_BOTH
        },
        backgroundColor: '#87CEEB',
        antialias: true,
        render: {
            pixelArt: false,
            antialias: true,
            powerPreference: 'high-performance' 
        },
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 1500 },
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    const game = new Phaser.Game(config);

    let player;
    let princess;
    let cursors;
    let finalImage;
    let finalImageContainer;
    let isGameFinished = false;
    let isGameStarted = false; // OYUN BA≈ûLADI MI KONTROL√ú
    let startContainer; // Giri≈ü ekranƒ± grubu
    let score = 0;
    let scoreText;
    let hearts;
    let music;
    let movingPlatforms;
    let emitter;
    let background;
    
    let btnLeft, btnRight, btnJump;
    let isLeftDown = false;
    let isRightDown = false;
    let isJumpDown = false;

    let mapWidth = 4000; 
    const GROUND_HEIGHT = 64; 

    function preload() {
        this.load.audio('theme', 'muzik.mp3');
        
        this.load.image('ground', 'https://raw.githubusercontent.com/photonstorm/phaser3-examples/master/public/assets/tilemaps/tiles/super-mario.png');
        this.load.image('block', 'https://raw.githubusercontent.com/photonstorm/phaser3-examples/master/public/assets/sprites/block.png');
        this.load.image('sparkle', 'https://labs.phaser.io/assets/particles/blue.png');
        this.load.image('heart', 'https://labs.phaser.io/assets/sprites/heart.png');
        this.load.image('skyBackground', 'https://labs.phaser.io/assets/skies/sky4.png'); 
        
        this.load.image('prens', 'prens.png');
        this.load.image('prenses', 'prenses.png');
        this.load.image('finalScene', 'final.png');
        this.load.image('kule', 'kule.png');
    }

    function create() {
        // Tam ekran olayƒ±nƒ± yine tutuyoruz ama m√ºzik ba≈ülatmayƒ± butona baƒülayacaƒüƒ±z
        this.input.once('pointerdown', () => {
            if (!this.scale.isFullscreen && this.scale.startFullscreen) {
                this.scale.startFullscreen();
            }
        });

        music = this.sound.add('theme', { loop: true, volume: 0.5 });

        background = this.add.tileSprite(0, 0, this.scale.width, this.scale.height, 'skyBackground');
        background.setOrigin(0, 0);
        background.setScrollFactor(0);
        
        let scaleX = this.scale.width / background.width;
        let scaleY = this.scale.height / background.height;
        let scale = Math.max(scaleX, scaleY);
        background.setScale(scale);

        const platforms = this.physics.add.staticGroup();
        const bottomY = this.scale.height - GROUND_HEIGHT;

        // --- ZORLA≈ûTIRILMI≈û PARKUR TASARIMI ---
        // Artƒ±k boydan boya zemin YOK. Par√ßa par√ßa adalar var.
        
        // 1. Ba≈ülangƒ±√ß (G√ºvenli Alan)
        createFloor(this, platforms, 0, 600); 

        // 2. ƒ∞lk Atlayƒ±≈ü (Bo≈üluk var!)
        createFloor(this, platforms, 800, 1200);

        // 3. Merdivenler ve Bo≈üluklar
        createBlock(platforms, 1400, bottomY - 50);
        createBlock(platforms, 1600, bottomY - 150);
        
        // 4. Uzak Ada
        createFloor(this, platforms, 1900, 2300);

        // 5. Zorlu Kƒ±sƒ±m (Hareketli Platformlar √úzerinden Ge√ßi≈ü)
        // Burada zemin yok, sadece hareketli platformlar var!
        
        // 6. Final Yolu
        createFloor(this, platforms, 3200, 4000); // Prensesin olduƒüu yer

        // --- HAREKETLƒ∞ PLATFORMLAR (Sayƒ±yƒ± artƒ±rdƒ±k) ---
        movingPlatforms = this.physics.add.group({allowGravity: false, immovable: true});
        
        // ƒ∞lk hareketli (Basit)
        let mp1 = movingPlatforms.create(700, bottomY - 50, 'ground').setDisplaySize(120, 32);
        mp1.setMoveData(650, 750, 100);

        // ƒ∞kinci hareketli (Zorlu ge√ßi≈ü i√ßin)
        let mp2 = movingPlatforms.create(2600, bottomY - 100, 'ground').setDisplaySize(120, 32);
        mp2.setMoveData(2400, 2800, 150); // Uzun mesafe gidip geliyor

        // √ú√ß√ºnc√º hareketli (Y√ºksekte)
        let mp3 = movingPlatforms.create(3000, bottomY - 200, 'ground').setDisplaySize(100, 32);
        mp3.setMoveData(2900, 3100, 120);


        emitter = this.add.particles('sparkle').createEmitter({
            speed: { min: -50, max: 50 }, angle: { min: 0, max: 360 }, scale: { start: 0.2, end: 0 },
            blendMode: 'ADD', on: false, lifespan: 300, gravityY: -100
        });

        // --- PRENS ---
        player = this.physics.add.sprite(100, bottomY - 50, 'prens');
        player.setOrigin(0.5, 1); 
        player.setDisplaySize(60, 120); 
        player.body.setSize(40, 75); 
        player.body.setOffset(10, 15); 
        player.setBounce(0.0); 
        player.setCollideWorldBounds(false); // D√ºnyadan d√º≈üebilsin (Zorluk i√ßin)
        emitter.startFollow(player);

        // --- KULE ---
        let tower = this.add.image(mapWidth - 150, bottomY + 20, 'kule');
        tower.setOrigin(0.5, 1); 
        tower.setDisplaySize(350, 450);

        // --- PRENSES ---
        princess = this.physics.add.staticSprite(mapWidth - 300, bottomY, 'prenses');
        princess.setOrigin(0.5, 1); 
        princess.setDisplaySize(70, 110);
        princess.setFlipX(true);
        princess.body.setSize(40, 80);
        princess.body.setOffset(10, 5);
        princess.refreshBody(); 

        // --- KALPLER (Zor yerlere koyalƒ±m) ---
        hearts = this.physics.add.group();
        // Rastgele deƒüil, elle koyalƒ±m ki d√º≈üme riski olsun
        createHeart(hearts, 700, bottomY - 150); // Hareketli √ºst√º
        createHeart(hearts, 1500, bottomY - 100); // Blok √ºst√º
        createHeart(hearts, 2600, bottomY - 200); // Hareketli √ºst√º
        createHeart(hearts, 3000, bottomY - 250); // Y√ºksek hareketli √ºst√º
        // Yolda da olsun biraz
        for(let i=0; i<5; i++) {
            createHeart(hearts, 3300 + (i*100), bottomY - 50);
        }

        this.physics.add.collider(player, platforms);
        this.physics.add.collider(player, movingPlatforms, moveWithPlatform, null, this);
        this.physics.add.collider(hearts, platforms);
        this.physics.add.collider(hearts, movingPlatforms);
        this.physics.add.overlap(player, princess, reachPrincess, null, this);
        this.physics.add.overlap(player, hearts, collectHeart, null, this);

        scoreText = this.add.text(20, 20, 'Toplanan Sevgi: 0', { 
            fontSize: '28px', fill: '#FFF', fontStyle: 'bold', stroke: '#000', strokeThickness: 4
        }).setScrollFactor(0);

        this.cameras.main.setBounds(0, 0, mapWidth, this.scale.height);
        this.cameras.main.startFollow(player, true, 0.08, 0.08);

        createVirtualButtons(this);
        cursors = this.input.keyboard.createCursorKeys();

        finalImageContainer = this.add.container(0, 0).setScrollFactor(0).setVisible(false).setDepth(200);
        finalImage = this.add.image(0, 0, 'finalScene');
        finalImageContainer.add(finalImage);

        // --- Gƒ∞Rƒ∞≈û EKRANI OLU≈ûTURMA (En Sonda) ---
        createStartScreen(this);

        this.input.addPointer(2);
        this.scale.on('resize', resize, this);
    }

    // --- Gƒ∞Rƒ∞≈û EKRANI FONKSƒ∞YONU ---
    function createStartScreen(scene) {
        startContainer = scene.add.container(0, 0).setScrollFactor(0).setDepth(9999);
        
        // Siyah perde
        let overlay = scene.add.rectangle(0, 0, scene.scale.width, scene.scale.height, 0x000000, 0.85);
        overlay.setOrigin(0, 0);
        
        // Ba≈ülƒ±k
        let title = scene.add.text(scene.scale.width / 2, scene.scale.height / 2 - 50, 'PRENSESƒ∞ KURTAR', {
            fontSize: '40px', fill: '#FFF', fontStyle: 'bold', stroke: '#000', strokeThickness: 6
        }).setOrigin(0.5);

        // Buton
        let startBtn = scene.add.text(scene.scale.width / 2, scene.scale.height / 2 + 50, '‚ñ∂ OYUNA BA≈ûLA', {
            fontSize: '32px', fill: '#0f0', fontStyle: 'bold', backgroundColor: '#333', padding: {x: 20, y: 10}
        }).setOrigin(0.5).setInteractive();

        startContainer.add([overlay, title, startBtn]);

        // Butona basƒ±nca
        startBtn.on('pointerdown', () => {
            isGameStarted = true;
            startContainer.setVisible(false);
            if (!music.isPlaying) music.play();
        });
        
        // Resize i√ßin overlay boyutunu g√ºncelle
        scene.events.on('resize', (gameSize) => {
            overlay.setSize(gameSize.width, gameSize.height);
            title.setPosition(gameSize.width/2, gameSize.height/2 - 50);
            startBtn.setPosition(gameSize.width/2, gameSize.height/2 + 50);
        });
    }

    function createFloor(scene, group, startX, endX) {
        let width = endX - startX;
        let centerX = startX + (width / 2);
        let y = scene.scale.height; 
        let floor = group.create(centerX, y, 'ground');
        floor.setOrigin(0.5, 1); 
        floor.setDisplaySize(width, GROUND_HEIGHT);
        floor.refreshBody();
    }

    function createBlock(group, x, y) {
        let block = group.create(x, y, 'block');
        block.setDisplaySize(64, 64);
        block.refreshBody();
    }
    
    function createHeart(group, x, y) {
        let heart = group.create(x, y, 'heart');
        heart.setDisplaySize(35, 35);
        heart.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
        heart.body.setCircle(15);
    }

    function resize (gameSize) {
        const width = gameSize.width;
        const height = gameSize.height;
        this.cameras.main.setViewport(0, 0, width, height);
        if (background) background.setSize(width, height);

        if(btnLeft) {
            btnLeft.setPosition(40, height - 130);
            btnRight.setPosition(180, height - 130);
            btnJump.setPosition(width - 150, height - 130);
        }
    }

    function update() {
        // --- OYUN BA≈ûLAMADIYSA HAREKET ETME ---
        if (!isGameStarted || isGameFinished) return;

        background.tilePositionX = this.cameras.main.scrollX * 0.3;

        movingPlatforms.children.iterate(function (platform) {
            if (platform.moveRight) {
                platform.body.setVelocityX(platform.moveSpeed);
                if (platform.x > platform.maxMoveX) platform.moveRight = false;
            } else {
                platform.body.setVelocityX(-platform.moveSpeed);
                if (platform.x < platform.minMoveX) platform.moveRight = true;
            }
        });

        let isMoving = false;
        if (cursors.left.isDown || isLeftDown) {
            player.setVelocityX(-300);
            player.setFlipX(true);
            isMoving = true;
        } else if (cursors.right.isDown || isRightDown) {
            player.setVelocityX(300);
            player.setFlipX(false);
            isMoving = true;
        } else {
            player.setVelocityX(0);
        }

        if (isMoving && player.body.touching.down) emitter.on = true;
        else emitter.on = false;

        if ((cursors.up.isDown || isJumpDown) && player.body.touching.down) {
            player.setVelocityY(-600);
            emitter.on = false;
        }

        // --- D√ú≈ûERSE BA≈ûA SAR ---
        if (player.y > this.scale.height + 200) {
            this.scene.restart();
            // Restart yapƒ±nca deƒüi≈ükenler sƒ±fƒ±rlanƒ±r, tekrar start ekranƒ± gelir.
            // Eƒüer tekrar start ekranƒ± gelmesin istiyorsan, logic deƒüi≈ümeli ama ≈üimdilik g√ºvenli olan bu.
            score = 0;
            isGameStarted = false; 
        }
    }

    function moveWithPlatform(player, platform) {
        if (player.body.touching.down && platform.body.touching.up) {
            player.body.velocity.x += platform.body.velocity.x;
        }
    }

    Phaser.GameObjects.Sprite.prototype.setMoveData = function(min, max, speed) {
        this.minMoveX = min;
        this.maxMoveX = max;
        this.moveSpeed = speed;
        this.moveRight = true;
    };

    function collectHeart (player, heart) {
        heart.disableBody(true, true);
        score += 10;
        scoreText.setText('Toplanan Sevgi: ' + score);
    }

    function reachPrincess(player, princess) {
        isGameFinished = true;
        this.physics.pause();
        player.setVisible(false);
        princess.setVisible(false);
        scoreText.setVisible(false);
        if(btnLeft) btnLeft.setVisible(false);
        if(btnRight) btnRight.setVisible(false);
        if(btnJump) btnJump.setVisible(false);
        emitter.setVisible(false);

        finalImageContainer.setVisible(true);
        finalImageContainer.setPosition(this.scale.width / 2, this.scale.height / 2);
        const w = this.scale.width;
        const h = this.scale.height;
        finalImage.setDisplaySize(w, h);

        this.add.text(this.scale.width / 2, 50, 'MUTLU SON ‚ù§Ô∏è', {
            fontSize: '50px', fill: '#fff', stroke: '#000', strokeThickness: 8, fontFamily: 'Arial Black'
        }).setOrigin(0.5).setScrollFactor(0).setDepth(201);
    }

    function createVirtualButtons(scene) {
        const h = scene.scale.height;
        const w = scene.scale.width;
        const style = { fontSize: '90px', fill: '#FFF', stroke: '#000', strokeThickness: 4 };

        btnLeft = scene.add.text(40, h - 130, '‚¨ÖÔ∏è', style).setScrollFactor(0).setInteractive();
        btnLeft.on('pointerdown', () => { isLeftDown = true; });
        btnLeft.on('pointerup', () => { isLeftDown = false; });
        btnLeft.on('pointerout', () => { isLeftDown = false; });

        btnRight = scene.add.text(180, h - 130, '‚û°Ô∏è', style).setScrollFactor(0).setInteractive();
        btnRight.on('pointerdown', () => { isRightDown = true; });
        btnRight.on('pointerup', () => { isRightDown = false; });
        btnRight.on('pointerout', () => { isRightDown = false; });

        btnJump = scene.add.text(w - 150, h - 130, '‚è´', style).setScrollFactor(0).setInteractive();
        btnJump.on('pointerdown', () => { isJumpDown = true; });
        btnJump.on('pointerup', () => { isJumpDown = false; });
        btnJump.on('pointerout', () => { isJumpDown = false; });
    }
</script>

</body>
</html>
